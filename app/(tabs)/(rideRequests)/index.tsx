import { RideRequestsScreen } from '@/src/features/rideRequests/screens';
import { webSocketService } from '@/src/services/socket/webSocketService';
import { selectUser } from '@/src/store/selectors/authSelectors';
import { setNewRideRequest } from '@/src/store/slices/requestedRide';
import React, { useEffect } from 'react';
import { useDispatch, useSelector } from 'react-redux';

export default function RideRequestsRoute() {
  console.log('ðŸš— RideRequestsRoute is rendering!');
  const dispatch = useDispatch();



  const user = useSelector(selectUser);

  useEffect(() => {
    if (user?.id) {
      console.log('ðŸ”‘ Connecting WebSocket for user:', user.id);

      webSocketService
        .connect(user.id)
        .then(() => console.log('âœ… WebSocket connected successfully'))
        .catch((error) => console.error('âŒ WebSocket connection failed:', error));

      const unsubscribeMessage = webSocketService.onMessage((message) => {
        console.log('ðŸ“© Message received in App:', message);
      });

      const unsubscribeConnection = webSocketService.onConnectionChange((connected) => {
        console.log('ðŸŒ WebSocket connection status changed:', connected);
      });

      const unsubscribeNewRide = webSocketService.onNewRideRequest((data) => {
        console.log('ðŸ”¥ Received new ride for driver:', data);
        dispatch(setNewRideRequest(data));
      });

      return () => {
        console.log('ðŸ‘‹ Cleaning up WebSocket connection');
        unsubscribeMessage();
        unsubscribeConnection();
        unsubscribeNewRide();
        webSocketService.disconnect();
      };
    }
  }, [user?.id]);

  return <RideRequestsScreen />;
}